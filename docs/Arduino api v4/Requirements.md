# Требования к проекту
---

# Содержание
1) [Версия документа](#doc_version)  
1) [Список изменений](#revisions)  
1) [Введение](#intro)  
2) [Аналоги](#analogues)
2) [Требования пользователя](#user_requires)  
    1) [Программные интерфейсы](#program_interfaces)  
        1) [Протокол взаимодействия](#protocol)  
        1) [Список поддерживаемых команд](#supported_commands)  
    2) [Внешние аппаратные интерфейсы](#external_hardware_interfaces)  
    3) [Характеристики пользователей](#user_description)  
    4) [Предположения и зависимости](#dependencies)  
3) [Системные требования](#system_requires)  
    1) [Функциональные требования](#functional_requires)  
    2) [Нефункциональные требования](#nonfunctional_requires)  
        1) [Атрибуты качаства](#quality_attributes)  
        1) [Ограничения](#limitations)  

<a name="doc_version"/>

# Версия документа

1.7

<a name="revisions"/>

# Список изменений

- Версия 1.7 (2018.04.20)
    Явно добавлен разделитель параметров команд
- Версия 1.6 (2017.12.05)
    В списке поддерживаемых команд поправлены принимаемые параметры в подразделе "Гусеницы" для команды с идентификатором `09`. Добавлена команда с идентификатором `0B`. Добавлены идентификаторы гусениц
- Версия 1.5 (2017.11.21)
    В списке поддерживаемых команд поправлены принимаемые параметры в подразделе "Гусеницы" и возвращаемые значения в подразделе "Сервоприводы"
- Версия 1.4 (2017.10.29)
    В фунциональных требованиях поправлены формулировки требований к отключению
- Версия 1.3 (2017.10.29)
    В фунциональных требованиях объединено взаимодействие с поворотной платформой в один общий пункт
- Версия 1.2 (2017.10.28)
    В фунциональных требованиях уточнена работа по протоколу
- Версия 1.1 (2017.10.19)
    В фунциональных требованиях добавлено подтребование по получению информации о текущем положении
    сервоприводов в соответствии со [списком поддерживаемых команд](#supported_commands)
- Версия 1.0 (2017.10.10)
    Написана основная версия

<a name="intro"/>

# Введение

<!-- Во введении описывается контекст проекта. Определить название продукта. В общих чертах описать, что продукт будет делать и чего он делать не будет (определить границы проекта) -->
Название проекта: trackPlatform.  
Вид проекта: аппаратно-программная платформа (далее - аппаратная платформа, платформа).  
Данный проект предназначен для помощи студентам и разработчикам, работающим с программным 
обеспечением (далее - ПО), которое не связано программированием микроконтроллеров, 
использовать микроконтроллеры
и их возможности для выполнения поставленных задач. Цель данного проекта - написать программное
обеспечение для микроконтроллера (далее - прошивку) и предоставить программисту интерфейсы для 
взаимодействия с hardware-уровнем (уровнем микроконтроллеров) и использованием его возможностей с
помощью отправки команд микроконтроллеру. 
Сама аппаратная платформа должна уметь:  
- передавать информацию с датчиков расстояния и линии в режиме реального времени;  
- перемещаться в пространстве в двух плоскостях, используя гусеницы (т.е. устройство
   не должно уметь летать);  
- управлять поворотной платформой, установленной на корпусе (вращение относительно двух осей);
- принимать команды для их последующей обработки и ответа на них, если требуется.

<a name="analogues"/>

# Аналоги

Данный проект имеет аналог: свою предыдущую версию. Предыдущая версия проекта не имеет
четкой структуры и для добавления новых функций в систему требуется переписывать
большое количество имеющегося кода. Требуется по возможности устранить данные недостатки
системы.
Также в данной реализации требуется убрать поддержку редко используемых команд.

<a name="user_requires"/>

# Требования пользователя  

<a name="program_interfaces"/>

## Программные интерфейсы  
<!-- Перечислить внешние системы / библиотеки / сервисы, с которыми продукт будет взаимодйствовать. -->
Данное устройство должно взаимодействовать только с API (библиотекой для взаимодействия 
с данной аппаратной платформой), написанных на разных языках 
программирования, используя свою прошивку. Сами API могут быть использованы в различных
приложениях, например:  
- управление платформой с помощью смартфона;  
- системы исследования местности.  

Взаимодействие с API должно проводиться как с использованием проводных (через USB-кабель),
 так и беспроводных (через Bluetooth) систем связи (подробнее см. [тут](#external_hardware_interfaces)).
  API может быть реализовано самим 
 разработчиком, так и сторонними. Обе стороны (API и платформа) обязаны безукоризеннно
 следовать [протоколу](#protocol).

<a name="protocol"/>

### Протокол взаимодействия  
Для взаимодействия с платформой требуется реализовать протокол, который будет принимать команды и отвечать на них.  
Формат любой посылки (на прием или передачу):  
*<размер данных> <данные> <контрольная сумма>*  

| Элемент команды   | Размер                                   | Описание                                 |
| :---------------- | :--------------------------------------- | :--------------------------------------- |
| Размер данных     | 1 байт                                   | Размер данных в байтах (пересылается в двоичном виде) |
| Данные            | До 255 байт включительно (ограничено возможностями поля "Размер данных") | Пересылаемые данные                      |
| Контрольная сумма | 2 байта                                  | Контрольная сумма, рассчитанная по алгоритму CRC-16 IBM (полином версии 0x8005) |

Формат данных команды (отправляется из приложения через API на устройство):  
*<контроллер> <команда контролера> <параметры команды (если требуется командой)>*  

| Элемент команды     | Описание                                 |
| :------------------ | :--------------------------------------- |
| Контроллер          | выбор контроллера (контроллер движения, датчиков, сервопривода или связи) |
| Команда контроллера | команда контроллеру (например: движение вперед) |
| Параметры команды   | необязательный параметр, обычно одно или несколько чисел в виде строки (а не в двоичном виде), разделяемые символом-разделителем `;` (0x3B) и которые прилагаются к команде |

Формат данных ответа полностью зависит от команды, на которую платформа будет отправлять ответ.
<a name="service_answers"/>
Ответы также могут быть управляющими (синхронизирующими). Существует два вида управляющих ответов:  
- OK
- ERROR

Первый - утвердительный, второй - отрицательный.  
При полном приеме команды от приложения будет сформирован ответ: 
утвердительный - при принятии команды без повреждений, отрицательный - в случаях 
повреждения посылки либо принятии команды с несоответствующим форматом.
При посылке отрицательного ответа на команду платформа переходит в режим ожидания команды.
Также по завершению выполнения команды будет возвращен один из управляющих ответов. 
Только после этого настоятельно рекомендуется посылать следующую команду.

Если некоторый промежуток времени (определяется заводскими настройками) на платформу не будет подана какая-либо из команд, определенных протоколом, произойдет сброс соединения по таймауту.

<a name="supported_commands"/>

### Список поддерживаемых команд  

Ниже приведен список контроллеров с их HEX-идентификаторами (в скобках) и их поддерживаемые команды:
- Гусеницы (01)

| Команда (ее HEX-идентификатор) | Параметры |
|:---|:---|
| Установка скорости обоих гусениц (0B) | 1. Скорость движения в промежутке [-255, 255] для левой гусеницы; 2. Скорость движения в промежутке [-255, 255] для правой гусеницы |
| Установка скорости какой-то конкретной гусеницы (09) | 1. [Идентификатор гусеницы](#track_type); 2. Скорость движения в промежутке [-255, 255] |
| Движение вперед (06) | 1. Скорость движения в промежутке [-255, 255] |
| Поворот по часовой стрелке (0A) | 1. Скорость поворота в промежутке [-255, 255] |
| Полная остановка (05) | - |

<a name="track_type"/>

| Расположение гусеницы относительно направления движения вперед | Идентификатор |
|:---|:---|
| Левая | 0 |
| Правая | 1 |

- Сервоприводы (03)

| Команда (ее HEX-идентификатор)           | Параметры                                | Возвращаемое значение                    |
| :--------------------------------------- | :--------------------------------------- | :--------------------------------------- |
| Установить угол для определенной оси (05) | 1. [Идентификатор оси](#axis_type); 2. Угол отклонения от от левого крайнего положения в градусах (промежуток [0, 180]) | -                                        |
| Получить текущий угол отклонения от левого края (06) | 1. [Идентификатор оси](#axis_type)       | Угол отклонения от левого края в градусах (промежуток [0, 180]) |

<a name="axis_type"/>

| Плоскость | Идентификатор |
| :-------- | :------------ |
| xy        | 1             |
| xz        | 2             |

- Датчики (02)

| Команда (ее HEX-идентификатор)           | Параметры                                | Возвращаемое значение                    |
| :--------------------------------------- | :--------------------------------------- | :--------------------------------------- |
| Получить информацию с датчиков расстояния (01) | 1. Идентификатор датчика (номер датчика с 1) | Расстояние до препятствия в сантиметрах  |
| Получить информацию со всех датчиков расстояния одновременно (02) | -                                        | Расстояние до препятствия каждого датчика в сантиметрах (от меньшего номера датчика к большему) |
| Получить информацию с датчиков линии (03) | 1. Идентификатор датчика (номер датчика с 1) | [Информация о типе области](#area_type)  |
| Получить информацию со всех датчиков линии одновременно (04) | -                                        | [Информация о типе области](#area_type) каждого датчика (от меньшего номера датчика к большему) |

<a name="area_type"/>

| Информация о типе области | Идентификатор |
| :------------------------ | :------------ |
| Светлая                   | 0             |
| Темная                    | 1             |

- Системные команды (04)

| Команда (ее HEX-идентификатор)           | Параметры                                |
| :--------------------------------------- | :--------------------------------------- |
| Подключение (01)                         | 1. Версия используемого API (в бинарном виде, для этой версии HEX-представление: 04) |
| Отключение (02)                          | -                                        |
| Поддержка соединения, "пустая" команда (03) | -                                        |

<!-- <a name="user_interface"/>

## Интерфейс пользователя  
Описать, как система будет взаимодействовать с пользователем. Возможны следующие варианты описания:
- текстовое
- иллюстрации (мокапы)
- таблицы “действие пользователя - реакция” -->

<a name="external_hardware_interfaces"/>

## Внешние аппаратные интерфейсы

Для общения с платформой могут быть использованы следующие способы соединения с платформой:

1. USB;  
2. Bluetooth;  

Требуется реализовать поддержку каждого из них.

<a name="user_description"/>

## Характеристики пользователей  
<!-- Идентифицировать пользователей (группы пользователей) и описать их характеристики (включая уровень образования, опыт, техническую грамотность) -->
Данное решение предназначено для студентов технических специальностей (будущих разработчиков ПО)
 и разработчиков, которые знакомы с последовательными протоколами передачи данных
 (например, RS-232) и их видами и которые понимают как они функционируют.


<a name="dependencies"/>

## Предположения и зависимости  
<!-- Перечислить факторы, которые могут повлиять на требования к системе, описанные в данном документе. -->
На требования к данной платформе и протоколу для взаимодействия с ней могут повлиять:

- добавление новых интерфейсов связи или данных (например, Wi-Fi, SD карты);
- изменение требований к ПО;
- добавление других видов датчиков для платформы (например, компаса);

<a name="system_requires"/>

# Системные требования  
<!-- Этот раздел должен содержать требования к продукту описанные на уровне достаточном для однозначного понимания того, как система может быть спроектирована и протестирована на предмет удовлетворения данных требований. -->

<a name="functional_requires"/>

## Функциональные требования  
<!-- Можно представить в виде нумерованного списка (для однозначной идентификации требований) -->

1. возможность подключения к платформе;
2. возможность принудительного отключения от платформы;
3. автоматическое отключение от платформы по истечению определенного промежутка времени;
4. управление гусеничной платформой (управление движением):  
    - движение вперед;
    - движение назад;
    - разворот по направлению движения часовой стрелки;
    - разворот против направления движения часовой стрелки;
5. взаимодействие с поворотной платформой:
    - управление поворотной платформой:  
        - поворот в плоскости xy;
        - поворот в плоскости xz;
    - получение информации о текущем состоянии сервоприводов:
        - получение текущего угла отклонения в плоскости xy;
        - получение текущего угла отклонения в плоскости xz;
6. получение корректной информации с датчиков линии (с "заводской" калибровкой датчиков
  в виде констант);  
7. получение корректной информации с датчиков расстояния (с "заводской" калибровкой датчиков 
  в виде констант);

<a name="nonfunctional_requires"/>

## Нефункциональные требования 

<a name="quality_attributes"/>

### Атрибуты качества
<!-- Перечислить атрибуты качества, важные для данной системы (надёжность, безопасность и т.д.) и пояснить почему они важны и как они должны измеряться. -->

Данные требования должны быть учтены при проектировании и написании текущей прошивки:

1. Масштабируемость: 
    - оставить возможность одновременной поддержки нескольких версий API (версия API определяется по команде подключения);
    - добавить возможность дальнейшего расширения функционала:
        - возможность изменения конфигурации платформы без перепрошивки модуля (пинов, настроек модулей);
        - увеличение числа имеющихся датчиков (до 255 штук) без изменения API;
        - добавление новых видов датчиков с дополнением API;
2. Надежность:
    - платформа должна выполнять только те команды, которые дошли полностью и без повреждений:
        - должно быть обеспечено протоколом передачи сообщений: длина сообщения и контрольная сумма.

<a name="limitations"/>

### Ограничения

Разработка должна вестить на аппаратной платформе, на которой была реализована предыдущая версия прошивки:

| Оборудование                             | Количество |
| :--------------------------------------- | :--------- |
| Arduino Mega R3                          | 1 шт.      |
| Arduino Mega Sensor Shield v2.0          | 1 шт.      |
| Датчики линии TCRT5000                   | 5 шт.      |
| Переходная плата для датчиков линии      | 1 шт.      |
| Датчики расстояния GP2Y0A21YK0F          | 5 шт.      |
| Переходная плата для датчиков расстояния | 1 шт.      |
| Bluetooth HC-05 с переходной платой FC-114 | 1 шт.      |
| Сервопривод SG-90                        | 2 шт.      |
| Драйвер двигателя L298N                  | 1 шт.      |

