# ESP 8266

В данном разделе расположены прошивки для ESP8266 модуля (проверялось на ESP8266-07).

## Прошивка модуля

Прошивки скомпилированы из библиотеки [nodemcu](https://github.com/nodemcu/nodemcu-firmware) с помощью [специального сайта](https://nodemcu-build.com/).

В прошивке присутствуют следующие модули (их 7):

* file
* gpio
* net
* node
* tmr (timer)
* uart
* wifi

Для залития прошивки на модуль использовалась утилита `ESP8266Flasher`, которую можно найти [тут](https://github.com/nodemcu/nodemcu-flasher).

Документацию для перевода esp в режим прошивки или выхода из него можно найти [тут](https://github.com/esp8266/esp8266-wiki/wiki/Boot-Process#esp-boot-modes).

## Скрипты для автоматической настройки модуля

В папке `lua-source` расположены файлы, предназначенные для загрузки на esp модуль после его прошивки для его автоматической настройки. Требуется загружать все файлы из папки.

Загрузка производилась через утилиту `ESPlorel`.

В скриптах автоматической настройки стоит защита, которая позволяет залить скрипты в течении 5 секунд перед выполением остальных скриптов. Эта особенность может помочь, если выполнение какого-либо из остальных (кроме `init.lua`) скриптов приводит к перезагрузке модуля.

## Протокол общения по UART

В качестве конца передачи пакета данных используется символ с кодом 13: `"\n"`.

Если в посылке встречается символ с кодом 13, он заменяется набором символов  со следующими кодами: 10 и 11.

Если в посылке встречается символ с кодом 10: `"\r"`, он экранируется дополнительным символом с кодом 10.

### Установка соединения с модулем

Установка соединения основана на трехэтапном рукопожатии (3-way handshake). 

По завершению запуска модуля по UART отправляется `I'm ready, Milord!` с периодичностью 10 секунд.

Модуль ждет ответа `Sir`, отвечает `Yes, Sir` и переходит в режим "Соедиение установлено".

**Внимание!** Всё общение с модулем должно работать по протоколу, в том числе и установление соединения.

